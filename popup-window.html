<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pop up window</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="https://cdn.permisso.io/widget/common/favicon-black.ico"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Size selector */
      .size-selector {
        margin-bottom: 20px;
        padding: 20px;
        background: var(--gray50);
        border-radius: 8px;
        border: 2px solid var(--catskill);
      }

      .size-selector h3 {
        color: var(--gray900);
        font-size: 16px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .size-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .size-btn {
        padding: 8px 16px;
        background: var(--white);
        color: var(--black);
        border: 2px solid var(--light-gray);
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .size-btn:hover {
        border-color: var(--primary);
        background: var(--blue);
      }

      .size-btn.active {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
      }

      .size-info {
        margin-top: 10px;
        font-size: 13px;
        color: var(--pale-sky);
      }

      /* Hide size selector on mobile */
      @media (max-width: 768px) {
        .size-selector {
          display: none;
        }
      }

      .event-log {
        margin-top: 30px;
        padding: 20px;
        background: var(--white);
        border-radius: 8px;
        border: 2px solid var(--catskill);
        max-height: 400px;
        overflow-y: auto;
      }

      .event-log h3 {
        color: var(--gray900);
        font-size: 16px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .event-item {
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 4px solid var(--primary);
        background: var(--gray50);
        font-size: 14px;
      }

      .event-item.results-screen {
        border-left-color: var(--robin-egg-blue);
      }

      .event-item.user-closure {
        border-left-color: var(--primary);
      }

      .event-item.session-completed {
        border-left-color: var(--yellow500);
      }

      .event-item.cancelled {
        border-left-color: var(--red500);
      }

      .event-item.expired {
        border-left-color: var(--orange500);
      }

      .event-name {
        font-weight: 600;
        color: var(--black);
        margin-bottom: 4px;
      }

      .event-time {
        color: var(--gray);
        font-size: 12px;
        margin-bottom: 4px;
      }

      .event-data {
        color: var(--pale-sky);
        font-size: 13px;
        font-family: monospace;
      }

      .no-events {
        text-align: center;
        color: var(--gray);
        padding: 20px;
        font-style: italic;
      }

      .popup-status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        display: none;
      }

      .popup-status.active {
        display: block;
      }

      .popup-status.open {
        background: var(--blue);
        border-left: 4px solid var(--robin-egg-blue);
        color: var(--primary);
      }

      .popup-status.closed {
        background: var(--gray50);
        border-left: 4px solid var(--gray);
        color: var(--gray900);
      }

      .session-id-display {
        margin-top: 8px;
        padding: 8px 12px;
        background: var(--white);
        border-radius: 4px;
        border: 1px solid var(--light-gray);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: nowrap;
      }

      .session-id-label {
        font-weight: 600;
        color: var(--gray900);
        font-size: 12px;
        white-space: nowrap;
      }

      .session-id-value {
        flex: 1;
        font-family: monospace;
        color: var(--primary);
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .copy-btn {
        padding: 4px 12px;
        background: var(--primary);
        color: var(--white);
        border: none;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        white-space: nowrap;
      }

      .copy-btn:hover {
        opacity: 0.8;
      }

      .copy-btn.copied {
        background: var(--robin-egg-blue);
      }
    </style>
  </head>
  <body>
    <div class="page-container">
      <h1 class="center-text">Pop up window</h1>
      <a href="index.html" class="back-link">‚Üê Back to Main</a>

      <!-- Size Selector -->
      <div class="size-selector">
        <h3>üì± Test Different Window Sizes</h3>
        <div class="size-buttons">
          <button class="size-btn active" data-width="500" data-height="700">
            Default (500√ó700)
          </button>
          <button class="size-btn" data-width="768" data-height="1024">
            Tablet (768√ó1024)
          </button>
          <button class="size-btn" data-width="375" data-height="667">
            iPhone SE (375√ó667)
          </button>
          <button class="size-btn" data-width="390" data-height="844">
            iPhone 12/13 (390√ó844)
          </button>
          <button class="size-btn" data-width="414" data-height="896">
            iPhone Pro Max (414√ó896)
          </button>
          <button class="size-btn" data-width="360" data-height="640">
            Android (360√ó640)
          </button>
          <button class="size-btn" data-width="1024" data-height="768">
            Desktop (1024√ó768)
          </button>
        </div>
        <div class="size-info" id="sizeInfo">
          Current size: 500√ó700px (will be applied when you open the popup)
        </div>
      </div>

      <div class="popup-controls">
        <button id="openPopupBtn" class="popup-button">
          Open Pop-up Window
        </button>
        <p class="info-message" id="popupMessage"></p>
        <div id="popupStatus" class="popup-status"></div>
      </div>

      <div class="event-log">
        <h3>Event Log (PostMessage API)</h3>
        <div id="eventList" class="no-events">
          No events received yet. Open the pop-up window to see events.
        </div>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      // Get the default link and open it in a popup window
      const defaultLink = localStorage.getItem("defaultLink");
      const openBtn = document.getElementById("openPopupBtn");
      const messageEl = document.getElementById("popupMessage");
      const eventList = document.getElementById("eventList");
      const popupStatus = document.getElementById("popupStatus");
      const sizeInfo = document.getElementById("sizeInfo");
      let popupWindow = null;
      let eventCount = 0;
      let selectedWidth = 500;
      let selectedHeight = 700;

      // Size selector functionality
      const sizeButtons = document.querySelectorAll(".size-btn");
      sizeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          selectedWidth = parseInt(btn.dataset.width);
          selectedHeight = parseInt(btn.dataset.height);

          // Update active button
          sizeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // Update info text
          sizeInfo.textContent = `Current size: ${selectedWidth}√ó${selectedHeight}px (will be applied when you open the popup)`;
        });
      });

      // Function to add event to the log
      function logEvent(eventName, eventData, description) {
        eventCount++;

        // Remove "no events" message
        if (eventList.querySelector(".no-events")) {
          eventList.innerHTML = "";
        }

        // Determine event class based on event name
        let eventClass = "";
        if (eventName === "results_screen_shown") {
          eventClass = "results-screen";
        } else if (eventName === "user_requested_closure") {
          eventClass = "user-closure";
        } else if (eventName === "session_completed") {
          eventClass = "session-completed";
        } else if (eventName === "session_cancelled") {
          eventClass = "cancelled";
        } else if (
          eventName === "token_expired" ||
          eventName === "session_expired"
        ) {
          eventClass = "expired";
        }

        const eventItem = document.createElement("div");
        eventItem.className = `event-item ${eventClass}`;

        let sessionIdHtml = "";
        if (eventData.sessionId) {
          const copyBtnId = `copy-${eventCount}`;
          sessionIdHtml = `
            <div class="session-id-display">
              <span class="session-id-label">Session ID:</span>
              <span class="session-id-value">${eventData.sessionId}</span>
              <button class="copy-btn" id="${copyBtnId}" onclick="copySessionId('${eventData.sessionId}', '${copyBtnId}')">Copy</button>
            </div>
          `;
        }

        eventItem.innerHTML = `
          <div class="event-name">${eventName}</div>
          <div class="event-time">${new Date().toLocaleTimeString()}</div>
          ${
            description
              ? `<div style="color: var(--pale-sky); margin-top: 4px;">${description}</div>`
              : ""
          }
          ${sessionIdHtml}
          <div class="event-data">${JSON.stringify(eventData, null, 2)}</div>
        `;

        // Add to top of list
        eventList.insertBefore(eventItem, eventList.firstChild);
      }

      // Function to copy session ID
      window.copySessionId = function (sessionId, btnId) {
        navigator.clipboard.writeText(sessionId).then(() => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.textContent = "Copied!";
            btn.classList.add("copied");
            setTimeout(() => {
              btn.textContent = "Copy";
              btn.classList.remove("copied");
            }, 2000);
          }
        });
      };

      // Listen for PostMessage events from the popup
      window.addEventListener("message", (event) => {
        // Check if message is from Permisso (has event.name property)
        if (!event.data || !event.data.name) {
          return;
        }

        const eventName = event.data.name;
        const sessionId = event.data.sessionId;

        console.log("Received Permisso event:", eventName, event.data);

        // Handle different events
        switch (eventName) {
          case "results_screen_shown":
            logEvent(
              eventName,
              event.data,
              "‚úÖ Results screen is now shown. Session completed (unless async models are pending)."
            );
            updatePopupStatus("Results screen displayed", "open");
            break;

          case "user_requested_closure":
            logEvent(
              eventName,
              event.data,
              "üö™ User clicked Close/Finish button. Closing pop-up window..."
            );
            updatePopupStatus(
              "User requested closure - Window will close",
              "closed"
            );

            // Close the popup window after user requests closure
            setTimeout(() => {
              if (popupWindow && !popupWindow.closed) {
                popupWindow.close();
                updatePopupStatus(
                  "Pop-up window closed by user request",
                  "closed"
                );
              }
            }, 1500); // Small delay to show feedback
            break;

          case "session_completed":
            logEvent(
              eventName,
              event.data,
              "‚ö†Ô∏è DEPRECATED: Use results_screen_shown instead. Session completed."
            );
            break;

          case "session_cancelled":
            logEvent(
              eventName,
              event.data,
              "‚ùå Session was cancelled by the user."
            );
            updatePopupStatus("Session cancelled", "closed");
            setTimeout(() => {
              if (popupWindow && !popupWindow.closed) {
                popupWindow.close();
              }
            }, 2000);
            break;

          case "token_expired":
            logEvent(
              eventName,
              event.data,
              "‚è∞ Authentication token expired (48h limit)."
            );
            updatePopupStatus("Token expired", "closed");
            break;

          case "session_expired":
            logEvent(
              eventName,
              event.data,
              "‚è∞ Session expired (expiresAt surpassed)."
            );
            updatePopupStatus("Session expired", "closed");
            break;

          case "uanataca_parking_page_shown":
            logEvent(
              eventName,
              event.data,
              'üÖøÔ∏è Uanataca: User in "waiting for review" state.'
            );
            break;

          default:
            logEvent(eventName, event.data, "Unknown event received.");
        }
      });

      function updatePopupStatus(message, status) {
        if (popupStatus) {
          popupStatus.textContent = message;
          popupStatus.className = `popup-status active ${status}`;
        }
      }

      // Check if popup is closed periodically
      let popupCheckInterval = null;

      if (!defaultLink) {
        if (messageEl) {
          messageEl.textContent =
            "No default link set. Please go back and configure a link.";
          messageEl.className = "error-message";
        }
        if (openBtn) openBtn.disabled = true;
      } else {
        if (openBtn) {
          openBtn.addEventListener("click", () => {
            popupWindow = window.open(
              defaultLink,
              "permissoPopup",
              `width=${selectedWidth},height=${selectedHeight},scrollbars=yes,resizable=yes`
            );

            if (popupWindow) {
              if (messageEl) {
                messageEl.textContent = "Pop-up window opened successfully!";
                messageEl.className = "info-message success";
              }

              updatePopupStatus(
                "Pop-up window is open - waiting for events...",
                "open"
              );

              // Clear previous events when opening new popup
              eventList.innerHTML =
                '<div class="no-events">Waiting for events from pop-up window...</div>';
              eventCount = 0;

              // Check if popup is manually closed
              if (popupCheckInterval) {
                clearInterval(popupCheckInterval);
              }

              popupCheckInterval = setInterval(() => {
                if (popupWindow && popupWindow.closed) {
                  clearInterval(popupCheckInterval);
                  updatePopupStatus("Pop-up window was closed", "closed");
                  logEvent("popup_closed", {}, "üî¥ Pop-up was closed.");
                }
              }, 500);
            } else {
              if (messageEl) {
                messageEl.textContent =
                  "Pop-up blocked! Please allow pop-ups for this site.";
                messageEl.className = "error-message";
              }
            }
          });
        }
      }
    </script>
  </body>
</html>
