<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iframe</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Size selector */
      .size-selector {
        margin-bottom: 20px;
        padding: 20px;
        background: var(--gray50);
        border-radius: 8px;
        border: 2px solid var(--catskill);
      }

      .size-selector h3 {
        color: var(--gray900);
        font-size: 16px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .size-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .size-btn {
        padding: 8px 16px;
        background: var(--white);
        color: var(--black);
        border: 2px solid var(--light-gray);
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .size-btn:hover {
        border-color: var(--primary);
        background: var(--blue);
      }

      .size-btn.active {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
      }

      .size-info {
        margin-top: 10px;
        font-size: 13px;
        color: var(--pale-sky);
      }

      .iframe-container {
        width: 100%;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: flex-start;
      }

      .iframe-container iframe {
        display: block;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(37, 44, 50, 0.08);
        border: 2px solid var(--catskill);
      }

      .event-log {
        margin-top: 30px;
        padding: 20px;
        background: var(--white);
        border-radius: 8px;
        border: 2px solid var(--catskill);
        max-height: 400px;
        overflow-y: auto;
      }

      .event-log h3 {
        color: var(--gray900);
        font-size: 16px;
        margin-bottom: 15px;
        font-weight: 500;
      }

      .event-item {
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        border-left: 4px solid var(--primary);
        background: var(--gray50);
        font-size: 14px;
      }

      .event-item.results-screen {
        border-left-color: var(--robin-egg-blue);
      }

      .event-item.user-closure {
        border-left-color: var(--primary);
      }

      .event-item.session-completed {
        border-left-color: var(--yellow500);
      }

      .event-item.cancelled {
        border-left-color: var(--red500);
      }

      .event-item.expired {
        border-left-color: var(--orange500);
      }

      .event-name {
        font-weight: 600;
        color: var(--black);
        margin-bottom: 4px;
      }

      .event-time {
        color: var(--gray);
        font-size: 12px;
        margin-bottom: 4px;
      }

      .event-data {
        color: var(--pale-sky);
        font-size: 13px;
        font-family: monospace;
      }

      .session-id-display {
        margin-top: 8px;
        padding: 8px 12px;
        background: var(--white);
        border-radius: 4px;
        border: 1px solid var(--light-gray);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: nowrap;
      }

      .session-id-label {
        font-weight: 600;
        color: var(--gray900);
        font-size: 12px;
        white-space: nowrap;
      }

      .session-id-value {
        flex: 1;
        font-family: monospace;
        color: var(--primary);
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .copy-btn {
        padding: 4px 12px;
        background: var(--primary);
        color: var(--white);
        border: none;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        white-space: nowrap;
      }

      .copy-btn:hover {
        opacity: 0.8;
      }

      .copy-btn.copied {
        background: var(--robin-egg-blue);
      }

      .no-events {
        text-align: center;
        color: var(--gray);
        padding: 20px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="page-container">
      <h1 class="center-text">Iframe</h1>
      <a href="index.html" class="back-link">‚Üê Back to Main</a>

      <!-- Size Selector -->
      <div class="size-selector">
        <h3>üì± Test Different Window Sizes</h3>
        <div class="size-buttons">
          <button class="size-btn active" data-width="100%" data-height="600">
            Desktop (Full Width)
          </button>
          <button class="size-btn" data-width="768" data-height="1024">
            Tablet (768√ó1024)
          </button>
          <button class="size-btn" data-width="375" data-height="667">
            iPhone SE (375√ó667)
          </button>
          <button class="size-btn" data-width="390" data-height="844">
            iPhone 12/13 (390√ó844)
          </button>
          <button class="size-btn" data-width="414" data-height="896">
            iPhone Pro Max (414√ó896)
          </button>
          <button class="size-btn" data-width="360" data-height="640">
            Android (360√ó640)
          </button>
        </div>
        <div class="size-info" id="sizeInfo">
          Current size: Full Width √ó 600px
        </div>
      </div>

      <div class="iframe-container" id="iframeContainer">
        <p class="info-message">Loading iframe...</p>
      </div>

      <div class="event-log">
        <h3>Event Log (PostMessage API)</h3>
        <div id="eventList" class="no-events">
          No events received yet. Events will appear here as they occur.
        </div>
      </div>
    </div>

    <script src="app.js"></script>
    <script>
      // Load the default link and display it in an iframe
      const defaultLink = localStorage.getItem("defaultLink");
      const container = document.getElementById("iframeContainer");
      const eventList = document.getElementById("eventList");
      const sizeInfo = document.getElementById("sizeInfo");
      let eventCount = 0;
      let currentIframe = null;

      // Size selector functionality
      const sizeButtons = document.querySelectorAll(".size-btn");
      sizeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const width = btn.dataset.width;
          const height = btn.dataset.height;

          // Update active button
          sizeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // Update iframe size
          if (currentIframe) {
            if (width === "100%") {
              // Desktop mode: iframe fills container
              currentIframe.style.width = "100%";
              currentIframe.style.height = height + "px";
              currentIframe.style.minHeight = height + "px";
              currentIframe.style.margin = "0";
              sizeInfo.textContent = `Current size: Full Width √ó ${height}px`;
            } else {
              // Device mode: set iframe to device size and center
              currentIframe.style.width = width + "px";
              currentIframe.style.height = height + "px";
              currentIframe.style.minHeight = height + "px";
              currentIframe.style.margin = "0 auto";
              sizeInfo.textContent = `Current size: ${width}√ó${height}px`;
            }
          }
        });
      });

      // Function to add event to the log
      function logEvent(eventName, eventData, description) {
        eventCount++;

        // Remove "no events" message
        if (eventList.querySelector(".no-events")) {
          eventList.innerHTML = "";
        }

        // Determine event class based on event name
        let eventClass = "";
        if (eventName === "results_screen_shown") {
          eventClass = "results-screen";
        } else if (eventName === "user_requested_closure") {
          eventClass = "user-closure";
        } else if (eventName === "session_completed") {
          eventClass = "session-completed";
        } else if (eventName === "session_cancelled") {
          eventClass = "cancelled";
        } else if (
          eventName === "token_expired" ||
          eventName === "session_expired"
        ) {
          eventClass = "expired";
        }

        const eventItem = document.createElement("div");
        eventItem.className = `event-item ${eventClass}`;

        let sessionIdHtml = "";
        if (eventData.sessionId) {
          const copyBtnId = `copy-${eventCount}`;
          sessionIdHtml = `
            <div class="session-id-display">
              <span class="session-id-label">Session ID:</span>
              <span class="session-id-value">${eventData.sessionId}</span>
              <button class="copy-btn" id="${copyBtnId}" onclick="copySessionId('${eventData.sessionId}', '${copyBtnId}')">Copy</button>
            </div>
          `;
        }

        eventItem.innerHTML = `
          <div class="event-name">${eventName}</div>
          <div class="event-time">${new Date().toLocaleTimeString()}</div>
          ${
            description
              ? `<div style="color: var(--pale-sky); margin-top: 4px;">${description}</div>`
              : ""
          }
          ${sessionIdHtml}
          <div class="event-data">${JSON.stringify(eventData, null, 2)}</div>
        `;

        // Add to top of list
        eventList.insertBefore(eventItem, eventList.firstChild);
      }

      // Function to copy session ID
      window.copySessionId = function (sessionId, btnId) {
        navigator.clipboard.writeText(sessionId).then(() => {
          const btn = document.getElementById(btnId);
          if (btn) {
            btn.textContent = "Copied!";
            btn.classList.add("copied");
            setTimeout(() => {
              btn.textContent = "Copy";
              btn.classList.remove("copied");
            }, 2000);
          }
        });
      };

      // Listen for PostMessage events from the iframe
      window.addEventListener("message", (event) => {
        // Check if message is from Permisso (has event.name property)
        if (!event.data || !event.data.name) {
          return;
        }

        const eventName = event.data.name;
        const sessionId = event.data.sessionId;

        console.log("Received Permisso event:", eventName, event.data);

        // Handle different events
        switch (eventName) {
          case "results_screen_shown":
            logEvent(
              eventName,
              event.data,
              "‚úÖ Results screen is now shown. Session completed (unless async models are pending). You can fetch the Session Summary."
            );
            break;

          case "user_requested_closure":
            logEvent(
              eventName,
              event.data,
              "üö™ User clicked Close/Finish button. In iframe mode, you may want to hide the iframe or navigate away."
            );
            break;

          case "session_completed":
            logEvent(
              eventName,
              event.data,
              "‚ö†Ô∏è DEPRECATED: Use results_screen_shown instead. Session completed."
            );
            break;

          case "session_cancelled":
            logEvent(
              eventName,
              event.data,
              "‚ùå Session was cancelled by the user."
            );
            break;

          case "token_expired":
            logEvent(
              eventName,
              event.data,
              "‚è∞ Authentication token expired (48h limit)."
            );
            break;

          case "session_expired":
            logEvent(
              eventName,
              event.data,
              "‚è∞ Session expired (expiresAt surpassed)."
            );
            break;

          case "uanataca_parking_page_shown":
            logEvent(
              eventName,
              event.data,
              'üÖøÔ∏è Uanataca: User in "waiting for review" state.'
            );
            break;

          default:
            logEvent(eventName, event.data, "Unknown event received.");
        }
      });

      if (defaultLink) {
        const iframe = document.createElement("iframe");
        iframe.src = defaultLink;
        iframe.title = "Embedded page";
        iframe.allow =
          "camera https://widget.sandbox.permisso.io https://widget.permisso.io; microphone https://widget.sandbox.permisso.io https://widget.permisso.io";
        // Default: desktop mode
        iframe.style.width = "100%";
        iframe.style.height = "600px";
        iframe.style.minHeight = "600px";
        iframe.style.margin = "0";
        container.innerHTML = "";
        container.appendChild(iframe);
        currentIframe = iframe;
      } else {
        container.innerHTML =
          '<p class="error-message">No default link set. Please go back and configure a link.</p>';
      }
    </script>
  </body>
</html>
